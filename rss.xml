<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
<channel>
<title><![CDATA[Personal Notes by ramajd]]></title>
<description><![CDATA[Personal Notes by ramajd]]></description>
<link>https://ramajd.github.io/</link>
<lastBuildDate>Tue, 21 Jun 2022 23:28:06 +0430</lastBuildDate>
<item>
  <title><![CDATA[Qt bindings of GStreamer on Android (failed experience)]]></title>
  <description><![CDATA[
<blockquote>
<p>
for the ones who may read this note, unfortunately I couldn't succeed to
provide a working solution. however I decided to write my findings here, hat
hopefully help someone else that wants to cdo the same thing in the future. the
source code related to my tries is located on
<a href="https://github.com/ramajd/gstreamer-qt-android">this repository</a>.
</p>
</blockquote>

<p>
There are two things that we should consider when we want to start our journay:
</p>
<ul class="org-ul">
<li>first thing is that all the fancy automated tools provided by GStreamer team for
Android doesn't work here.</li>
<li>he second is that the Qt bindings are not available in the official pre-built
binaries and we need to create our own custom version of gstreamer library.</li>
</ul>


<div id="outline-container-org43c3a40" class="outline-2">
<h2 id="org43c3a40">Build the <code>libgstreamer_android.so</code></h2>
<div class="outline-text-2" id="text-org43c3a40">
<p>
Official tutorials of Gstreamer, are based on Android NDK build system, which
automatically build and deploy the <code>libgstreamer_android.so</code> library (absolutely
without Qt support!) to the target APK based on the plugins has been chosen
inside make file.
</p>

<p>
we need to replace it by custom targets in our <code>qmake</code> project file. to do so we
defined two custom targets to build and cleanup the <code>libgstreamer_android.so</code>
file for us:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #00ffff;">GSTREAMER_ROOT_ANDROID</span> = $$_PRO_FILE_PWD_/gstreamer-1.0/armv7

<span style="color: #00ffff;">gst.target</span> = $$ANDROID_PACKAGE_SOURCE_DIR/libs/armeabi-v7a/libgstreamer_android.so
<span style="color: #00ffff;">gst.commands</span> = cd $$ANDROID_PACKAGE_SOURCE_DIR; \
               ./build_gstreamer.sh TARGET_ARCH_ABI=armeabi-v7a \
               <span style="color: #00ffff;">GSTREAMER_ROOT_ANDROID</span>=$$GSTREAMER_ROOT_ANDROID \
               <span style="color: #00ffff;">NDK_PROJECT_PATH</span>=$$ANDROID_PACKAGE_SOURCE_DIR

<span style="color: #00ffff;">extraclean.commands</span> = rm -rv $$ANDROID_PACKAGE_SOURCE_DIR/libs $$ANDROID_PACKAGE_SOURCE_DIR/obj
<span style="color: #00ffff;">clean.depends</span> += extraclean

<span style="color: #00ffff;">QMAKE_EXTRA_TARGETS</span> += gst clean extraclean
<span style="color: #00ffff;">PRE_TARGETDEPS</span> += $$ANDROID_PACKAGE_SOURCE_DIR/libs/armeabi-v7a/libgstreamer_android.so
</pre>
</div>

<p>
since we don't have access to the environment variables during our custom
target, I wrote a custom bash script to first prepare the environment (the
Android relate paths), and then run the <code>ndk-build</code> for me:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b0c4de;">source</span> ~/.bashrc
ndk-build $<span style="color: #00ffff;">@</span>
</pre>
</div>

<p>
finally we have the requirements to build the <code>libgstreamer_android.so</code> based on
the make file we added to <code>android/jni/Android.mk</code>.
</p>
</div>
</div>


<div id="outline-container-orgaf5aac0" class="outline-2">
<h2 id="orgaf5aac0">Build the Gstreamer libraries including the Qt bindings</h2>
<div class="outline-text-2" id="text-orgaf5aac0">
<p>
The approach that I followed was to use the <code>cerbero</code> the build system which is
provided by GStreamer team to create custom bundles of GStreamer.
</p>

<p>
to do so, first we need to checkout the <code>cerbero</code> from it's <a href="https://gitlab.freedesktop.org/gstreamer/cerbero">repository</a> and
checkout the version we want to build.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ git clone https://gitlab.freedesktop.org/gstreamer/cerbero
$ cd cerbero
$ git checkout 1.20.1
</pre>
</div>

<p>
then we need to bootstrap the <code>cerbero</code> to have all of it's requirements. we
also need identify our cross compile configuration using one of the
configurations provided inside <code>config</code> folder. I used the
<code>config/cross-android-universal.cbc</code> config.
</p>

<p>
<b>Note</b>: in my experience I faced errors about missing python pacakges (<a href="https://pypi.org/project/distro/"><code>distro</code></a>), my
host OS (Manjaro) was also undefined for the bootstrap script, so I add it
manually, based on the error messages that I received.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ ./cerbero-uninstalled -c config/cross-android-universal.cbc bootstrap
</pre>
</div>

<p>
after preparing the environment, we go for building our custom GStreamer
bundle. to do so we use the <code>package</code> command and add the <code>qt5</code> variant to list
of it's default recipes.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b0c4de;">export</span> <span style="color: #00ffff;">QMAKE</span>=<span style="color: #8AE234;">'/path/to/Qt/5.15.2/android/bin/qmake'</span>
$ ./cerbero-uninstalled -c config/cross-android-universal.cbc -v qt5 package gstreamer-1.0
</pre>
</div>


<p>
following the above steps, we have a
<code>gstreamer-1.0-android-universal-1.20.1.tar.xz` file which including the Qt5
bindings. they will be added as ~GSTREAMER_PLUGINS_QT5</code> plugin to the list of
plugins.
</p>

<p>
however when I trying to create the <code>libgstreamer_android.so</code> using this bundle,
we receive following linker errors, which I didn't have a chance to fix them
yet.
</p>

<div class="org-src-container">
<pre class="src src-text">...
../gstqsgtexture.cc:36: error: undefined reference to 'QSGTexture::QSGTexture()'
../gstqsgtexture.cc:36: error: undefined reference to 'QOpenGLFunctions::QOpenGLFunctions()'
../gstqsgtexture.cc:40: error: undefined reference to 'QOpenGLFunctions::initializeOpenGLFunctions()'
../gstqsgtexture.cc:55: error: undefined reference to 'QSGTexture::~QSGTexture()'
../gstqsgtexture.cc:64: error: undefined reference to 'QOpenGLContext::functions() const'
../gstqsgtexture.cc:67: error: undefined reference to 'QSGTexture::~QSGTexture()'
../gstqsgtexture.cc:67: error: undefined reference to 'QSGTexture::~QSGTexture()'
../gstqsgtexture.cc:172: error: undefined reference to 'QOpenGLContext::functions() const'
armeabi-v7a/moc_gstqsgtexture.cpp:88: error: undefined reference to 'QSGTexture::qt_metacast(char const*)'
armeabi-v7a/moc_gstqsgtexture.cpp:93: error: undefined reference to 'QSGTexture::qt_metacall(QMetaObject::Call, int, void**)'
/home/reza/QtProjects/GStreamerTest/gstreamer-1.0/armv7/lib/gstreamer-1.0/libgstqmlgl.a(moc_gstqsgtexture.o):moc_gstqsgtexture.cpp:GstQSGTexture::staticMetaObject: error: undefined reference to 'QSGTexture::staticMetaObject'
/home/reza/QtProjects/GStreamerTest/gstreamer-1.0/armv7/lib/gstreamer-1.0/libgstqmlgl.a(moc_gstqsgtexture.o):moc_gstqsgtexture.cpp:vtable for GstQSGTexture: error: undefined reference to 'QSGTexture::normalizedTextureSubRect() const'
/home/reza/QtProjects/GStreamerTest/gstreamer-1.0/armv7/lib/gstreamer-1.0/libgstqmlgl.a(moc_gstqsgtexture.o):moc_gstqsgtexture.cpp:vtable for GstQSGTexture: error: undefined reference to 'QSGTexture::isAtlasTexture() const'
/home/reza/QtProjects/GStreamerTest/gstreamer-1.0/armv7/lib/gstreamer-1.0/libgstqmlgl.a(moc_gstqsgtexture.o):moc_gstqsgtexture.cpp:vtable for GstQSGTexture: error: undefined reference to 'QSGTexture::removedFromAtlas() const'
/home/reza/QtProjects/GStreamerTest/gstreamer-1.0/armv7/lib/gstreamer-1.0/libgstqmlgl.a(moc_gstqsgtexture.o):moc_gstqsgtexture.cpp:typeinfo for GstQSGTexture: error: undefined reference to 'typeinfo for QSGTexture'
clang++: error: linker command failed with exit code 1 (use -v to see invocation)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd6c054b" class="outline-2">
<h2 id="orgd6c054b">References</h2>
<div class="outline-text-2" id="text-orgd6c054b">
<p>
these are the usefull references that I found during my journay of working on
this issue:
</p>

<ul class="org-ul">
<li>a helpful blog post about: <a href="http://pepijndevos.nl/2018/10/02/qtgstreamerddsandroid.html">Qt+GStreamer+DDS+Android</a></li>
<li><a href="https://github.com/ArmsOfSorrow/gstreamer-android-qt-app">https://github.com/ArmsOfSorrow/gstreamer-android-qt-app</a></li>
<li><a href="https://github.com/ystreet/qt-gstreamer-android">https://github.com/ystreet/qt-gstreamer-android</a></li>
<li><a href="https://gstreamer.freedesktop.org/documentation/installing/building-from-source-using-cerbero.html?gi-language=c">GStreamer reference about how to use the cerbero</a></li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://ramajd.github.io/tags.html">Tags</a>: <a href="https://ramajd.github.io/tag-android.html">android</a> <a href="https://ramajd.github.io/tag-gstreamer.html">gstreamer</a> <a href="https://ramajd.github.io/tag-qt.html">Qt</a> </div>]]></description>
  <category><![CDATA[android]]></category>
  <category><![CDATA[gstreamer]]></category>
  <category><![CDATA[Qt]]></category>
  <link>https://ramajd.github.io/2022-04-19-qt-bindings-of-gstreamer-on-android-(failed-experience).html</link>
  <pubDate>Tue, 19 Apr 2022 18:46:00 +0430</pubDate>
</item>
<item>
  <title><![CDATA[Guix: how to set package udev rules]]></title>
  <description><![CDATA[
<blockquote>
<p>
Just read a <i><a href="https://lists.gnu.org/archive/html/guix-devel/2021-12/msg00095.html">thread</a></i> on guix mailing list, about <b>adding udev rules</b> for a
package. in order to have an fixed reference about it, I decided to post it
here.
</p>
</blockquote>

<p>
adding <code>udev</code> rules for a guix package is as easy as adding it to the
<code>&lt;out&gt;/lib/udev/rules.d/</code> directory. so we can either add it as an <code>INSTALL</code>
rule in our <code>CMakefile.txt</code> or add it to manually install the rules as part of
our package <code>install</code> phase:
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #729FCF;">define-public</span> <span style="color: #00ffff;">package-name</span>
  (package
   ...
   (arguments
    `(<span style="color: #b0c4de;">#:phases</span>
      (modify-phases %standard-phases
       (add-after 'unpack 'patch-udev-rules
         (<span style="color: #729FCF;">lambda*</span> (<span style="color: #b0c4de;">#:key</span> outputs <span style="color: #b0c4de;">#:allow-other-keys</span>)
           (<span style="color: #729FCF;">let</span> ((out (assoc-ref outputs <span style="color: #8AE234;">"out"</span>)))
             (substitute* <span style="color: #8AE234;">"CMakefile.txt"</span>
                          ((<span style="color: #8AE234;">"/ib/udev/rules.d"</span>)
                           (string-append out <span style="color: #8AE234;">"/lib/udev/rules.d"</span>)))
             #t))))))
   ...))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #729FCF;">define-public</span> <span style="color: #00ffff;">package-name</span>
  (package
   ...
   (arguments
    `(<span style="color: #b0c4de;">#:phases</span>
      (modify-phases %standard-phases
       (add-after 'install 'install-udev-rules
         (<span style="color: #729FCF;">lambda*</span> (<span style="color: #b0c4de;">#:key</span> outputs <span style="color: #b0c4de;">#:allow-other-keys</span>)
           (<span style="color: #729FCF;">let</span> ((out (assoc-ref outputs <span style="color: #8AE234;">"out"</span>)))
             (mkdir-p (string-append out <span style="color: #8AE234;">"/lib/udev/rules.d"</span>))
             (copy-file <span style="color: #8AE234;">"123-my-custom-udev.rules"</span>
                        (string-append out
                                       <span style="color: #8AE234;">"/lib/udev/rules.d/"</span>
                                       <span style="color: #8AE234;">"123-my-custom-udev.rules"</span>))
             #t))))))
   ...
   ))
</pre>
</div>
<div class="taglist"><a href="https://ramajd.github.io/tags.html">Tags</a>: <a href="https://ramajd.github.io/tag-guix.html">guix</a> </div>]]></description>
  <category><![CDATA[guix]]></category>
  <link>https://ramajd.github.io/2021-12-13-guix-how-to-set-package-udev-rules.html</link>
  <pubDate>Mon, 13 Dec 2021 11:43:00 +0330</pubDate>
</item>
<item>
  <title><![CDATA[New Start]]></title>
  <description><![CDATA[
<p>
After a while finally I decided to restore back my personal blog, writting down
challenges I'm facing with, during my daily work. this time I decided to write in
English, might be more useful for the ones who might face same issues.
</p>

<p>
One of the challenges that I faced was to choose a proper platform to build my
blog on top of. using blog services like <i>Blogger</i> or <i>Wordpress</i> previously
they seemd to be kind of over-qualified for my needs. so I decided to switch to
static blog generators this time.
</p>

<p>
It's been a while that I'm using <i><a href="https://guix.gnu.org">GNU Guix</a></i> on my work and it was an opportunity
for me to use <i><a href="https://www.gnu.org/software/emacs/">GNU Emacs</a></i> as my common text editor and IDE. working more with
Emacs, I love this editor much more.
</p>


<figure id="orgfd7552d">
<img src="./static/images/emacs_gnu_org_mode.png" alt="emacs_gnu_org_mode.png">

</figure>

<p>
Since for each problem you face, Emacs provides you a solution, it also has a
solution for my blogging Problem, <i><a href="https://orgmode.org/">Org Mode</a></i>. search for Emacs blogging tools,
there are a bunch of packages already available, and since I was looking for a
simple tool to allow me setup my blog rapidly, I decided to use
<i><a href="https://github.com/bastibe/org-static-blog">org-static-blog</a></i>.
</p>

<p>
In order to setup my blog, I just need to add an <a href="https://github.com/bastibe/org-static-blog#examples">initial configuration</a> to my
<code>init.el</code> file, create new post using <code>org-static-blog-create-new-post</code> and run
<code>org-static-blog-publish</code> to generate html files. after that the only thing that
I need to do was to publish generated files to <a href="https://pages.github.com/">github pages</a>.
</p>
<div class="taglist"><a href="https://ramajd.github.io/tags.html">Tags</a>: <a href="https://ramajd.github.io/tag-personal.html">personal</a> </div>]]></description>
  <category><![CDATA[personal]]></category>
  <link>https://ramajd.github.io/2020-12-04-new-start.html</link>
  <pubDate>Fri, 04 Dec 2020 15:10:00 +0330</pubDate>
</item>
</channel>
</rss>
