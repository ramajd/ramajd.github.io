<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://ramajd.github.io/rss.xml"
      title="RSS feed for https://ramajd.github.io/">
<title>Personal Notes by ramajd</title>

<meta name="author" content="Reza Alizadeh Majd">
<meta name="referrer" content="no-referrer">
<link href="/static/style.css" rel="stylesheet" type="text/css" />
<link rel="icon" href="/static/favicon.png"></head>
<body>
<div id="preamble" class="status">
<div class="header">
  <h1><a href="/">Personal Notes by ramajd</a></h1>
  <ul>
    <li><a href="/">Blog</a>
    <li><a href="/about.html">About</a>
  </ul>
</div></div>
<div id="content">
<h1 class="title">Posts tagged "android":</h1>
<div class="post-date">19 Apr 2022</div><h1 class="post-title"><a href="https://ramajd.github.io/2022-04-19-qt-bindings-of-gstreamer-on-android-(failed-experience).html">Qt bindings of GStreamer on Android (failed experience)</a></h1>
<blockquote>
<p>
for the ones who may read this note, unfortunately I couldn't succeed to
provide a working solution. however I decided to write my findings here, hat
hopefully help someone else that wants to cdo the same thing in the future. the
source code related to my tries is located on
<a href="https://github.com/ramajd/gstreamer-qt-android">this repository</a>.
</p>
</blockquote>

<p>
There are two things that we should consider when we want to start our journay:
</p>
<ul class="org-ul">
<li>first thing is that all the fancy automated tools provided by GStreamer team for
Android doesn't work here.</li>
<li>he second is that the Qt bindings are not available in the official pre-built
binaries and we need to create our own custom version of gstreamer library.</li>
</ul>


<div id="outline-container-org43c3a40" class="outline-2">
<h2 id="org43c3a40">Build the <code>libgstreamer_android.so</code></h2>
<div class="outline-text-2" id="text-org43c3a40">
<p>
Official tutorials of Gstreamer, are based on Android NDK build system, which
automatically build and deploy the <code>libgstreamer_android.so</code> library (absolutely
without Qt support!) to the target APK based on the plugins has been chosen
inside make file.
</p>

<p>
we need to replace it by custom targets in our <code>qmake</code> project file. to do so we
defined two custom targets to build and cleanup the <code>libgstreamer_android.so</code>
file for us:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #00ffff;">GSTREAMER_ROOT_ANDROID</span> = $$_PRO_FILE_PWD_/gstreamer-1.0/armv7

<span style="color: #00ffff;">gst.target</span> = $$ANDROID_PACKAGE_SOURCE_DIR/libs/armeabi-v7a/libgstreamer_android.so
<span style="color: #00ffff;">gst.commands</span> = cd $$ANDROID_PACKAGE_SOURCE_DIR; \
               ./build_gstreamer.sh TARGET_ARCH_ABI=armeabi-v7a \
               <span style="color: #00ffff;">GSTREAMER_ROOT_ANDROID</span>=$$GSTREAMER_ROOT_ANDROID \
               <span style="color: #00ffff;">NDK_PROJECT_PATH</span>=$$ANDROID_PACKAGE_SOURCE_DIR

<span style="color: #00ffff;">extraclean.commands</span> = rm -rv $$ANDROID_PACKAGE_SOURCE_DIR/libs $$ANDROID_PACKAGE_SOURCE_DIR/obj
<span style="color: #00ffff;">clean.depends</span> += extraclean

<span style="color: #00ffff;">QMAKE_EXTRA_TARGETS</span> += gst clean extraclean
<span style="color: #00ffff;">PRE_TARGETDEPS</span> += $$ANDROID_PACKAGE_SOURCE_DIR/libs/armeabi-v7a/libgstreamer_android.so
</pre>
</div>

<p>
since we don't have access to the environment variables during our custom
target, I wrote a custom bash script to first prepare the environment (the
Android relate paths), and then run the <code>ndk-build</code> for me:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b0c4de;">source</span> ~/.bashrc
ndk-build $<span style="color: #00ffff;">@</span>
</pre>
</div>

<p>
finally we have the requirements to build the <code>libgstreamer_android.so</code> based on
the make file we added to <code>android/jni/Android.mk</code>.
</p>
</div>
</div>


<div id="outline-container-orgaf5aac0" class="outline-2">
<h2 id="orgaf5aac0">Build the Gstreamer libraries including the Qt bindings</h2>
<div class="outline-text-2" id="text-orgaf5aac0">
<p>
The approach that I followed was to use the <code>cerbero</code> the build system which is
provided by GStreamer team to create custom bundles of GStreamer.
</p>

<p>
to do so, first we need to checkout the <code>cerbero</code> from it's <a href="https://gitlab.freedesktop.org/gstreamer/cerbero">repository</a> and
checkout the version we want to build.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ git clone https://gitlab.freedesktop.org/gstreamer/cerbero
$ cd cerbero
$ git checkout 1.20.1
</pre>
</div>

<p>
then we need to bootstrap the <code>cerbero</code> to have all of it's requirements. we
also need identify our cross compile configuration using one of the
configurations provided inside <code>config</code> folder. I used the
<code>config/cross-android-universal.cbc</code> config.
</p>

<p>
<b>Note</b>: in my experience I faced errors about missing python pacakges (<a href="https://pypi.org/project/distro/"><code>distro</code></a>), my
host OS (Manjaro) was also undefined for the bootstrap script, so I add it
manually, based on the error messages that I received.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ ./cerbero-uninstalled -c config/cross-android-universal.cbc bootstrap
</pre>
</div>

<p>
after preparing the environment, we go for building our custom GStreamer
bundle. to do so we use the <code>package</code> command and add the <code>qt5</code> variant to list
of it's default recipes.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b0c4de;">export</span> <span style="color: #00ffff;">QMAKE</span>=<span style="color: #8AE234;">'/path/to/Qt/5.15.2/android/bin/qmake'</span>
$ ./cerbero-uninstalled -c config/cross-android-universal.cbc -v qt5 package gstreamer-1.0
</pre>
</div>


<p>
following the above steps, we have a
<code>gstreamer-1.0-android-universal-1.20.1.tar.xz` file which including the Qt5
bindings. they will be added as ~GSTREAMER_PLUGINS_QT5</code> plugin to the list of
plugins.
</p>

<p>
however when I trying to create the <code>libgstreamer_android.so</code> using this bundle,
we receive following linker errors, which I didn't have a chance to fix them
yet.
</p>

<div class="org-src-container">
<pre class="src src-text">...
../gstqsgtexture.cc:36: error: undefined reference to 'QSGTexture::QSGTexture()'
../gstqsgtexture.cc:36: error: undefined reference to 'QOpenGLFunctions::QOpenGLFunctions()'
../gstqsgtexture.cc:40: error: undefined reference to 'QOpenGLFunctions::initializeOpenGLFunctions()'
../gstqsgtexture.cc:55: error: undefined reference to 'QSGTexture::~QSGTexture()'
../gstqsgtexture.cc:64: error: undefined reference to 'QOpenGLContext::functions() const'
../gstqsgtexture.cc:67: error: undefined reference to 'QSGTexture::~QSGTexture()'
../gstqsgtexture.cc:67: error: undefined reference to 'QSGTexture::~QSGTexture()'
../gstqsgtexture.cc:172: error: undefined reference to 'QOpenGLContext::functions() const'
armeabi-v7a/moc_gstqsgtexture.cpp:88: error: undefined reference to 'QSGTexture::qt_metacast(char const*)'
armeabi-v7a/moc_gstqsgtexture.cpp:93: error: undefined reference to 'QSGTexture::qt_metacall(QMetaObject::Call, int, void**)'
/home/reza/QtProjects/GStreamerTest/gstreamer-1.0/armv7/lib/gstreamer-1.0/libgstqmlgl.a(moc_gstqsgtexture.o):moc_gstqsgtexture.cpp:GstQSGTexture::staticMetaObject: error: undefined reference to 'QSGTexture::staticMetaObject'
/home/reza/QtProjects/GStreamerTest/gstreamer-1.0/armv7/lib/gstreamer-1.0/libgstqmlgl.a(moc_gstqsgtexture.o):moc_gstqsgtexture.cpp:vtable for GstQSGTexture: error: undefined reference to 'QSGTexture::normalizedTextureSubRect() const'
/home/reza/QtProjects/GStreamerTest/gstreamer-1.0/armv7/lib/gstreamer-1.0/libgstqmlgl.a(moc_gstqsgtexture.o):moc_gstqsgtexture.cpp:vtable for GstQSGTexture: error: undefined reference to 'QSGTexture::isAtlasTexture() const'
/home/reza/QtProjects/GStreamerTest/gstreamer-1.0/armv7/lib/gstreamer-1.0/libgstqmlgl.a(moc_gstqsgtexture.o):moc_gstqsgtexture.cpp:vtable for GstQSGTexture: error: undefined reference to 'QSGTexture::removedFromAtlas() const'
/home/reza/QtProjects/GStreamerTest/gstreamer-1.0/armv7/lib/gstreamer-1.0/libgstqmlgl.a(moc_gstqsgtexture.o):moc_gstqsgtexture.cpp:typeinfo for GstQSGTexture: error: undefined reference to 'typeinfo for QSGTexture'
clang++: error: linker command failed with exit code 1 (use -v to see invocation)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd6c054b" class="outline-2">
<h2 id="orgd6c054b">References</h2>
<div class="outline-text-2" id="text-orgd6c054b">
<p>
these are the usefull references that I found during my journay of working on
this issue:
</p>

<ul class="org-ul">
<li>a helpful blog post about: <a href="http://pepijndevos.nl/2018/10/02/qtgstreamerddsandroid.html">Qt+GStreamer+DDS+Android</a></li>
<li><a href="https://github.com/ArmsOfSorrow/gstreamer-android-qt-app">https://github.com/ArmsOfSorrow/gstreamer-android-qt-app</a></li>
<li><a href="https://github.com/ystreet/qt-gstreamer-android">https://github.com/ystreet/qt-gstreamer-android</a></li>
<li><a href="https://gstreamer.freedesktop.org/documentation/installing/building-from-source-using-cerbero.html?gi-language=c">GStreamer reference about how to use the cerbero</a></li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://ramajd.github.io/tags.html">Tags</a>: <a href="https://ramajd.github.io/tag-android.html">android</a> <a href="https://ramajd.github.io/tag-gstreamer.html">gstreamer</a> <a href="https://ramajd.github.io/tag-qt.html">Qt</a> </div><div id="archive">
<a href="https://ramajd.github.io/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status">
<center>
  <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/">
    <img alt="Creative Commons License" 
         style="border-width:0" 
         src="https://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a>
  <br />
  licensed under a 
  <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/">
    Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
</center></div>
</body>
</html>
